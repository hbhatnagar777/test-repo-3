<?xml version="1.0" encoding="UTF-8"?>
<App_SetCustomRuleRequest>
    <queryDetail doesQuerySupportOutputFilter="1" frequency="86400"
        isDisabled="0" isOverwriteAssociationAtAlertAllowed="0"
        isPrimaryKeyPresent="1" isQueryModifyEnabled="1"
        isRuleAssociatedWithAlert="0" isSystemCreated="0"
        queryCriteriaName="TFA disabled"
        queryDescription="&lt;html>&#xd;&#xa;  &lt;head>&#xd;&#xa;&#xd;&#xa;  &lt;/head>&#xd;&#xa;  &lt;body>&#xd;&#xa;    &lt;p style=&quot;margin-top: 0&quot;>&#xd;&#xa;      Generate alert if TFA got disable at commcell or company level&#xd;&#xa;    &lt;/p>&#xd;&#xa;    &lt;p style=&quot;margin-top: 0&quot;>&#xd;&#xa;      Generate alert if TFA was enabled for all users on commcell or company &#xd;&#xa;      level, and then for some userGroup TFA was disabled&#xd;&#xa;    &lt;/p>&#xd;&#xa;  &lt;/body>&#xd;&#xa;&lt;/html>&#xd;&#xa;"
        sqlQuery="DECLARE @TFADisabled INT = 0&#xa;DECLARE @TFAEnabledForAll INT = 1&#xa;DECLARE @TFAEnabledForUserGroups INT = 2&#xa;DECLARE @companyId INT = ISNULL((SELECT companyId FROM UMUsers WITH(NOLOCK) where id = @userId), 0)&#xa;DECLARE @companyName NVARCHAR(MAX) = ISNULL((SELECT domainName from UMDSProviders WITH(NOLOCK) where id = @companyId), '')&#xa;DECLARE @isTFAEnabledAtCompany INT = 0&#xa;DECLARE @tempProviderIds Table(providerId int primary key, providerName NVARCHAR(MAX))&#xa;DECLARE @tempGroupIds Table(groupId int primary key, description NVARCHAR(MAX))&#xa;&#xa;IF(@IncludeCompanyLevelChangesAlso = 1)&#xa;BEGIN&#xa;&#x9;IF(@companyId = 0) -- Commcell&#xa;&#x9;BEGIN&#xa;&#x9;&#x9;-- get all companies which have TFA enabled for all&#xa;&#x9;&#x9;INSERT INTO @tempProviderIds&#xa;&#x9;&#x9;&#x9;SELECT UMDSP.id, UMDSP.domainName&#xa;&#x9;&#x9;&#x9;FROM UMDSProviders UMDSP WITH(NOLOCK)&#xa;&#x9;&#x9;&#x9;INNER JOIN App_CompanyProp ACP WITH(NOLOCK) ON UMDSP.id = ACP.componentNameId AND ACP.attrname = 'EnableTwoFactorAuthentication' AND ACP.attrVal = '1'&#xa;&#x9;&#x9;&#x9;WHERE UMDSP.serviceType IN (2, 5, 6, 8, 9, 10, 14)&#xa;&#x9;END&#xa;END&#xa;&#xa;IF(@companyId &lt;> 0)&#xa;BEGIN&#xa;&#x9;SET @isTFAEnabledAtCompany = ISNULL((SELECT attrValInt FROM App_CompanyProp WITH(NOLOCK) WHERE attrname = 'EnableTwoFactorAuthentication' AND componentNameId = @companyId), 0)&#xa;END&#xa;ELSE -- Commcell User&#xa;BEGIN&#xa;&#x9;SET @isTFAEnabledAtCompany = ISNULL((SELECT value FROM GxGlobalParam WITH(NOLOCK) WHERE name = 'EnableTwoFactorAuthentication'), 0)&#xa;END&#xa;&#xa;&#xa;IF(@isTFAEnabledAtCompany = @TFADisabled)&#xa;BEGIN&#xa;&#x9;IF(@companyId &lt;> 0) -- Company&#xa;&#x9;BEGIN&#xa;&#x9;&#x9;INSERT INTO @tempGroupIds&#xa;&#x9;&#x9;&#x9;SELECT 0, 'TFA is disabled at company level'&#xa;&#x9;END&#xa;&#x9;ELSE&#xa;&#x9;BEGIN&#xa;&#x9;&#x9;INSERT INTO @tempGroupIds&#xa;&#x9;&#x9;&#x9;SELECT 0, 'TFA is disabled at commcell level'&#xa;&#x9;END&#xa;&#x9;&#xa;END&#xa;ELSE IF(@isTFAEnabledAtCompany = @TFAEnabledForAll)&#xa;BEGIN&#xa;&#x9;IF(@companyId &lt;> 0) -- Company&#xa;&#x9;BEGIN&#xa;&#x9;&#x9;INSERT INTO @tempGroupIds&#xa;&#x9;&#x9;&#x9;SELECT UMG.id,&#xa;&#x9;&#x9;&#x9;&#x9;CASE UMDSP.domainName&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN @companyName THEN 'TFA is disabled on user group: ' + UMG.name&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE 'TFA is disabled on user group: ' + UMDSP.domainName + '\' + UMG.name&#xa;&#x9;&#x9;&#x9;&#x9;END&#xa;&#x9;&#x9;&#x9;&#x9;FROM UMGroups UMG WITH(NOLOCK)&#xa;&#x9;&#x9;&#x9;&#x9;INNER JOIN UMDSProviders UMDSP ON (UMDSP.id = @companyId OR (UMDSP.serviceType IN (2, 6, 8, 9, 10, 14) AND UMDSP.ownerCompany = @companyId))&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;AND UMDSP.id = UMG.umdsProviderId&#xa;&#x9;&#x9;&#x9;&#x9;INNER JOIN UMGroupsProp UMGP ON UMGP.ComponentNameId = UMG.id&#xa;&#x9;&#x9;&#x9;&#x9;WHERE UMGP.attrName= 'DisableTwoFactorAuthentication' AND UMGP.attrVal = '1' &#xa;&#x9;END&#xa;&#x9;ELSE -- Commcell level&#xa;&#x9;BEGIN&#xa;&#x9;&#x9;IF(@IncludeCompanyLevelChangesAlso = 1)&#xa;&#x9;&#x9;BEGIN&#xa;&#x9;&#x9;&#x9;-- Get all usergroups which have tfa disabled (local + AD)&#xa;&#x9;&#x9;&#x9;INSERT INTO @tempGroupIds&#xa;&#x9;&#x9;&#x9;&#x9;SELECT UMG.id, 'TFA is disabled on user group: ' + UMG.name&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;FROM UMGroups UMG WITH(NOLOCK)&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN UMGroupsProp UMGP ON UMGP.ComponentNameId = UMG.id&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN UMDSProviders UMDSP ON (UMDSP.id = @companyId OR (UMDSP.serviceType IN (2, 6, 8, 9, 10, 14) AND UMDSP.ownerCompany = @companyId))&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;AND UMDSP.id = UMG.umdsProviderId&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHERE UMGP.attrName= 'DisableTwoFactorAuthentication' AND UMGP.attrVal = '1' &#xa;&#x9;&#x9;&#x9;&#x9;UNION&#xa;&#x9;&#x9;&#x9;&#x9;SELECT UMG.id, 'TFA is disabled on user group: ' + TPI.providerName + '\' + UMG.name&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;FROM UMGroups UMG WITH(NOLOCK)&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN UMGroupsProp UMGP ON UMGP.ComponentNameId = UMG.id&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN @tempProviderIds TPI ON TPI.providerId = UMG.umdsProviderId&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;WHERE UMGP.attrName= 'DisableTwoFactorAuthentication' AND UMGP.attrVal = '1' &#xa;&#x9;&#x9;END&#xa;&#x9;&#x9;ELSE&#xa;&#x9;&#x9;BEGIN&#xa;&#x9;&#x9;&#x9;-- Get commcell groups only (local + AD)&#xa;&#x9;&#x9;&#x9;INSERT INTO @tempGroupIds&#xa;&#x9;&#x9;&#x9;&#x9;SELECT UMG.id, 'TFA is disabled on user group: ' + UMG.name&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;FROM UMGroups UMG WITH(NOLOCK)&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN UMGroupsProp UMGP ON UMGP.ComponentNameId = UMG.id&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN UMDSProviders UMDSP ON (UMDSP.id = @companyId OR (UMDSP.serviceType IN (2, 6, 8, 9, 10, 14) AND UMDSP.ownerCompany = @companyId))&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;AND UMDSP.id = UMG.umdsProviderId&#xa;&#x9;&#x9;&#x9;&#x9;&#x9;WHERE UMGP.attrName= 'DisableTwoFactorAuthentication' AND UMGP.attrVal = '1' &#xa;&#x9;&#x9;END&#xa;&#x9;END&#xa;END&#xa;&#xa;&#xa;SELECT groupId, description  FROM @tempGroupIds"
        taskInfoXml="&lt;?xml version='1.0' encoding='UTF-8'?>&lt;TMMsg_TaskInfo>&lt;task description=&quot;&quot; ownerId=&quot;3&quot; runUserId=&quot;1&quot; taskType=&quot;2&quot; ownerName=&quot;master&quot; alertId=&quot;0&quot; GUID=&quot;b8866e71-ef10-41ba-9cb4-8d1c8a0581c5&quot; policyType=&quot;10&quot; associatedObjects=&quot;0&quot; taskName=&quot;&quot; taskId=&quot;0&quot;>&lt;securityAssociations>&lt;ownerAssociations>&lt;inheritedOwners>&lt;permission permissionId=&quot;7&quot; _type_=&quot;122&quot; permissionName=&quot;Install Package/Update&quot; />&lt;parents commCellName=&quot;pranshu-try&quot; commCellId=&quot;2&quot; _type_=&quot;1&quot; />&lt;/inheritedOwners>&lt;inheritedOwners>&lt;permission permissionId=&quot;12&quot; _type_=&quot;122&quot; permissionName=&quot;Data Protection/Management Operations&quot; />&lt;parents commCellName=&quot;pranshu-try&quot; commCellId=&quot;2&quot; _type_=&quot;1&quot; />&lt;/inheritedOwners>&lt;/ownerAssociations>&lt;tagWithCompany providerId=&quot;0&quot; providerDomainName=&quot;Commcell&quot; />&lt;/securityAssociations>&lt;originalCC commCellId=&quot;2&quot; />&lt;taskSecurity>&lt;associatedUserGroups userGroupId=&quot;1&quot; _type_=&quot;15&quot; userGroupName=&quot;master&quot; />&lt;advancedPrivacySettings authType=&quot;1&quot;>&lt;passkeySettings enableAuthorizeForRestore=&quot;0&quot;>&lt;expirationTime time=&quot;0&quot; />&lt;/passkeySettings>&lt;/advancedPrivacySettings>&lt;ownerCapabilities />&lt;/taskSecurity>&lt;createAs>&lt;user>&lt;user userName=&quot;admin&quot; userId=&quot;1&quot; />&lt;/user>&lt;/createAs>&lt;taskFlags isEdgeDrive=&quot;0&quot; isEZOperation=&quot;0&quot; forDDB=&quot;0&quot; uninstalled=&quot;0&quot; isServerPlanAssociated=&quot;0&quot; isSystem=&quot;0&quot; isIndexBackup=&quot;0&quot; disabled=&quot;0&quot; isEdiscovery=&quot;0&quot; />&lt;task taskName=&quot;&quot; taskId=&quot;3241&quot; />&lt;/task>&lt;appGroup />&lt;subTasks>&lt;subTask subTaskOrder=&quot;0&quot; subTaskName=&quot;&quot; subTaskType=&quot;1&quot; flags=&quot;0&quot; operationType=&quot;5014&quot; subTaskId=&quot;0&quot;>&lt;subTask subtaskId=&quot;3662&quot; subtaskName=&quot;&quot; />&lt;/subTask>&lt;pattern active_end_occurence=&quot;0&quot; freq_subday_interval=&quot;900&quot; freq_type=&quot;2048&quot; patternId=&quot;992&quot; flags=&quot;0&quot; description=&quot;Every week on Sunday,Monday,Tuesday,Wednesday,Thursday,Friday,Saturday at 0:00   and repeats every 0 hr(s) 15 min(s) until 23:59 &quot; active_end_time=&quot;86340&quot; active_end_date=&quot;0&quot; skipOccurence=&quot;0&quot; skipDayNumber=&quot;0&quot; active_start_time=&quot;0&quot; freq_restart_interval=&quot;0&quot; active_start_date=&quot;1634774400&quot; freq_interval=&quot;127&quot; freq_relative_interval=&quot;0&quot; name=&quot;&quot; freq_recurrence_factor=&quot;1&quot;>&lt;daysToRun week=&quot;0&quot; Monday=&quot;1&quot; Thursday=&quot;1&quot; Friday=&quot;1&quot; Sunday=&quot;1&quot; Wednesday=&quot;1&quot; Tuesday=&quot;1&quot; day=&quot;0&quot; Saturday=&quot;1&quot; />&lt;calendar calendarName=&quot;Standard&quot; calendarId=&quot;1&quot; />&lt;timeZone TimeZoneID=&quot;42&quot; />&lt;/pattern>&lt;options>&lt;backupOpts backupLevel=&quot;2&quot;>&lt;dataOpt autoCopy=&quot;0&quot; />&lt;/backupOpts>&lt;commonOpts>&lt;automaticSchedulePattern />&lt;/commonOpts>&lt;/options>&lt;/subTasks>&lt;/TMMsg_TaskInfo>" visibility="0">
        <creator userId="1" userName="admin"/>
        <commcellAssociation>
            <entity _type_="124" commCellId="2"/>
        </commcellAssociation>
        <additionalQueryDetails alertCriteria="0" alertType="0"
            isHealthParam="0" queryReturnsHTMLFormattedOutput="0" querySeverity="3">
            <scriptDescription
                description="&lt;html>&#xd;&#xa;  &lt;head>&#xd;&#xa;&#xd;&#xa;  &lt;/head>&#xd;&#xa;  &lt;body>&#xd;&#xa;    &lt;p style=&quot;margin-top: 0&quot;>&#xd;&#xa;      Generate alert if TFA got disable at commcell or company level&#xd;&#xa;    &lt;/p>&#xd;&#xa;    &lt;p style=&quot;margin-top: 0&quot;>&#xd;&#xa;      Generate alert if TFA was enabled for all users on commcell or company &#xd;&#xa;      level, and then for some userGroup TFA was disabled&#xd;&#xa;    &lt;/p>&#xd;&#xa;  &lt;/body>&#xd;&#xa;&lt;/html>&#xd;&#xa;"
                guid="2D5D27CE-AD9E-4C8A-9874-4E9BDF553D60"
                reportName="TFA disabled" revision="$Revision:  $ M&lt;1634892462859>"/>
        </additionalQueryDetails>
        <queryEntity queryId="0" queryName="TFA disabled"/>
        <queryParamsList>
            <queryParamsList attribute="0" className="java.lang.Boolean"
                controlHidden="0" controlType="5" defaultValue="false"
                displayName="Include company groups which had TFA disabled"
                documentation="Only for Commcell" hidden="0"
                inputName="IncludeCompanyLevelChangesAlso"
                inputType="java.lang.Boolean" listType="0"
                maximumValue="" minimumValue=""
                name="IncludeCompanyLevelChangesAlso" readOnly="0"
                required="0" searchable="0" type="{http://www.w3.org/2001/XMLSchema}boolean">
                <defaultValues val="false"/>
            </queryParamsList>
        </queryParamsList>
        <queryOutputColumns columnFriendlyName="groupId"
            columnName="groupId" isColumnFilterable="0" isPrimaryKey="1" lmDataType="0">
            <columnAdditionalDetails includeInAlertOutput="0" isAlertRecipient="0"/>
        </queryOutputColumns>
        <queryOutputColumns columnFriendlyName="description"
            columnName="description" isColumnFilterable="0"
            isPrimaryKey="0" lmDataType="1">
            <columnAdditionalDetails includeInAlertOutput="1" isAlertRecipient="0"/>
        </queryOutputColumns>
    </queryDetail>
</App_SetCustomRuleRequest>
